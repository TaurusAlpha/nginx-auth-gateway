# NGINX Rsyslog Configuration
# File: /etc/rsyslog.d/nginx.conf

# Set templates for NGINX logs
template(name="nginx-access-template" type="string" string="%msg%\n")
template(name="nginx-error-template" type="string" string="%timestamp% [%syslogseverity-text%] %msg%\n")

# Create dynamic file paths
template(name="nginx-access-file" type="string" string="{{ nginx_plus_log_dir if nginx_plus | bool else '/var/log/nginx' }}/{{ env }}_rsyslog_access.log")
template(name="nginx-error-file" type="string" string="{{ nginx_plus_log_dir if nginx_plus | bool else '/var/log/nginx' }}/{{ env }}_rsyslog_error.log")

# Filter and process NGINX access logs
if $programname startswith 'nginx_access' then {
    # Local file storage with proper formatting
    action(type="omfile"
           dynaFile="nginx-access-file"
           template="nginx-access-template")
    
    {% if forward_logs_to_remote | bool %}
    # Forward to remote syslog server if enabled
    action(type="omfwd"
           target="{{ syslog_server }}"
           port="{{ syslog_port }}"
           protocol="{{ syslog_protocol }}"
           template="nginx-access-template")
    {% endif %}
}

# Filter and process NGINX error logs
if $programname startswith 'nginx_error' then {
    # Local file storage with proper formatting
    action(type="omfile"
           dynaFile="nginx-error-file"
           template="nginx-error-template")
    
    {% if forward_logs_to_remote | bool %}
    # Forward to remote syslog server if enabled
    action(type="omfwd"
           target="{{ syslog_server }}"
           port="{{ syslog_port }}"
           protocol="{{ syslog_protocol }}"
           template="nginx-error-template")
    {% endif %}
}
