# NGINX Rsyslog Configuration
# File: /etc/rsyslog.d/nginx.conf

# Templates for log formatting
template(name="nginx-access-template" type="string" string="%msg%\n")
template(name="nginx-error-template" type="string" string="%timestamp% [%syslogseverity-text%] %msg%\n")

# Templates for dynamic file paths
template(name="nginx-access-file" type="string" string="{{ rsyslog_log_dir }}/nginx/{{ env }}_access.log")
template(name="nginx-error-file" type="string" string="{{ rsyslog_log_dir }}/nginx/{{ env }}_error.log")

# Process NGINX access logs
if $programname startswith 'nginx_access' then {
    # Write to local file
    action(type="omfile"
           dynaFile="nginx-access-file"
           template="nginx-access-template")
    
    {% if forward_logs_to_remote | bool %}
    # Forward to remote syslog server
    action(type="omfwd"
           target="{{ syslog_server }}"
           port="{{ syslog_port }}"
           protocol="{{ syslog_protocol }}"
           template="nginx-access-template")
    {% endif %}
}

# Process NGINX error logs
if $programname startswith 'nginx_error' then {
    # Write to local file
    action(type="omfile"
           dynaFile="nginx-error-file"
           template="nginx-error-template")
    
    {% if forward_logs_to_remote | bool %}
    # Forward to remote syslog server
    action(type="omfwd"
           target="{{ syslog_server }}"
           port="{{ syslog_port }}"
           protocol="{{ syslog_protocol }}"
           template="nginx-error-template")
    {% endif %}
}
